name: "Pickaroo Reviewers"

on:
  workflow_call:
    inputs:
      channel_id:
        required: true
        description: The Slack Channel ID to notify
        type: string
    secrets:
      SLACK_OAUTH_TOKEN:
        required: false
      OOI_PULL_REQUEST_APP:
        required: false

jobs:
  request-reviewers:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      selected-reviewers: ${{ steps.request-reviewers.outputs.selected-reviewers }}
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: "2454947"
          private-key: ${{ secrets.OOI_PULL_REQUEST_APP }}
      - uses: actions/checkout@v6
      - name: Request Reviewers
        id: request-reviewers
        uses: ./.github/actions/pickaroo
        with:
          include-teams: "innovation-platform-eng"
          exclude-teams: "business-dev resx-ccm-project"
          number-of-reviewers: 8
          token: ${{ steps.generate_token.outputs.token }}

  post-slack-message:
    needs: request-reviewers
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: "Map slack ids to usernames"
        id: map-slack-ids
        shell: bash
        run: |
          REVIEWERS_STRING='${{ needs.request-reviewers.outputs.selected-reviewers }}'

          if [ -n "$REVIEWERS_STRING" ]; then
            REVIEWERS_JSON=$(echo "$REVIEWERS_STRING" | tr ' ' '\n' | jq -R -s 'split("\n") | map(select(length > 0))')
            GH_SLACK_MAPPING='${{ vars.GH_SLACK_IDS }}'
            SLACK_MENTIONS=$(echo "$REVIEWERS_JSON" | jq -r --argjson mapping "$GH_SLACK_MAPPING" '
              map(. as $user | 
                if $mapping[$user] then 
                  "<@" + $mapping[$user] + ">" 
                else 
                  "@" + $user 
                end
              ) | 
              join(", ")
            ')
          else
            SLACK_MENTIONS=""
          fi

          echo "slack-mentions=$SLACK_MENTIONS" >> $GITHUB_OUTPUT
      - name: Send Slack message
        uses: ./.github/actions/slack-message
        with:
          channel_id: ${{ inputs.channel_id }}
          message: "[ <${{ github.event.pull_request.html_url }}|PR Review> ] ${{ github.event.repository.name }} - #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          thread_message: "Hey ${{ steps.map-slack-ids.outputs.slack-mentions }} ğŸ«µ! Pickaroo here ğŸ¦˜ğŸ‘‹ Please review the above pull request ğŸ™ğŸ•µï¸"
          token: ${{ secrets.SLACK_OAUTH_TOKEN }}

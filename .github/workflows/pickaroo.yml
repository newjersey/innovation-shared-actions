name: "Pickaroo Reviewers"

on:
  workflow_call:
    inputs:
      include_teams:
        description: The github teams to pick reviewers from (space delimited)
        type: "string"
        required: false
      exclude_teams:
        description: The github teams to exclude reviewers from (space delimited)
        type: "string"
        required: false
      include_users:
        description: Individual GitHub usernames to include (space delimited)
        type: "string"
        required: false
      exclude_users:
        description: Individual GitHub usernames to exclude (space delimited)
        type: "string"
        required: false
      number_of_reviewers:
        default: 1
        type: number
        description: The number of reviewers to select
      number_of_repicks:
        default: 1
        type: number
        description: The number of reviewers to select on subsequent runs
      channel_id:
        required: true
        description: The Slack Channel ID to notify
        type: string
      show:
        default: false
        type: boolean
        description: If true, only post a Slack message without selecting reviewers
    secrets:
      SLACK_OAUTH_TOKEN:
        required: false
      OOI_PULL_REQUEST_APP:
        required: false

jobs:
  request-reviewers:
    runs-on: ubuntu-latest
    outputs:
      reviewers: ${{ steps.request-reviewers.outputs.reviewers }}
      message-ts: ${{ steps.check-comment.outputs.message-ts }}
    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: "2454947"
          private-key: ${{ secrets.OOI_PULL_REQUEST_APP }}
      - name: Check for existing pickaroo comment
        id: check-comment
        run: |
          set -euo pipefail

          echo "Checking for existing pickaroo comment on PR #${{ github.event.pull_request.number }}"
          # Determines whether we're re-picking reviewers based on the presence of message-ts in a comment
          if ! COMMENT=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '
              [.[] | select(.user.login == "ooi-pull-request-app[bot]" and (.body | contains("message_ts:")))] |
              sort_by(.created_at) |
              last | {id: .id, body: .body} |
              @json' 2>&1); then
            echo "ERROR: Failed to fetch PR comments: $COMMENT"
            exit 1
          fi

          if [ -n "$COMMENT" ] && [ "$COMMENT" != "null" ]; then
            # grep may not find a match, which is fine - use || true to prevent failure
            MESSAGE_TS=$(echo "$COMMENT" | jq -r '.body' | grep -o 'message_ts: [0-9]\+\.[0-9]\+' | cut -d' ' -f2 || true)
            if [ -n "$MESSAGE_TS" ]; then
              echo "Found existing message_ts: $MESSAGE_TS"
              echo "message-ts=$MESSAGE_TS" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
      - uses: actions/checkout@v6
        if: ${{ !inputs.show }}
        with:
          repository: newjersey/innovation-shared-actions
      - name: Request Reviewers
        if: ${{ !inputs.show }}
        id: request-reviewers
        uses: ./.github/actions/pickaroo
        with:
          include_teams: ${{ inputs.include_teams }}
          include_users: ${{ inputs.include_users }}
          exclude_teams: ${{ inputs.exclude_teams }}
          exclude_users: ${{ inputs.exclude_users }}
          number_of_reviewers: ${{ steps.check-comment.outputs.message-ts != '' && inputs.number_of_repicks || inputs.number_of_reviewers }}
          github_slack_mapping: ${{ vars.GH_SLACK_USER_MAP }}
          slack_token: ${{ secrets.SLACK_OAUTH_TOKEN }}
          token: ${{ steps.generate-token.outputs.token }}

  post-slack-message:
    needs: [request-reviewers]
    runs-on: ubuntu-latest
    outputs:
      message-ts: ${{ steps.send-slack-message.outputs.message_ts }}
    steps:
      - uses: actions/checkout@v6
        with:
          repository: newjersey/innovation-shared-actions
      - name: "Look up Slack user IDs"
        if: ${{ !inputs.show }}
        id: lookup-slack-users
        uses: ./.github/actions/lookup-slack-users
        with:
          github_usernames: ${{ needs.request-reviewers.outputs.reviewers }}
          github_slack_mapping: ${{ vars.GH_SLACK_USER_MAP }}
      - name: "Look up PR author in Slack"
        id: lookup-pr-author
        uses: ./.github/actions/lookup-slack-users
        with:
          github_usernames: ${{ github.event.pull_request.user.login }}
          github_slack_mapping: ${{ vars.GH_SLACK_USER_MAP }}
      - name: Send Slack message
        id: send-slack-message
        uses: ./.github/actions/slack-message
        with:
          channel_id: ${{ inputs.channel_id }}
          message: "[ <${{ github.event.pull_request.html_url }}|PR ${{ inputs.show && 'Show' || 'Review' }}> ] ${{ github.event.repository.name }} - #${{ github.event.pull_request.number }} by ${{ steps.lookup-pr-author.outputs.formatted_string }}:\n\n*${{ github.event.pull_request.title }}*"
          message_ts: ${{ needs.request-reviewers.outputs.message-ts }}
          thread_message: ${{ needs.request-reviewers.outputs.reviewers != '' && format('Hey {0} ðŸ«µ! Please review this pull request ðŸ¦˜ðŸ™', steps.lookup-slack-users.outputs.formatted_string) || '' }}
          token: ${{ secrets.SLACK_OAUTH_TOKEN }}

  post-pr-comment:
    needs: [request-reviewers, post-slack-message]
    if: ${{ needs.request-reviewers.outputs.message-ts == '' && needs.request-reviewers.result == 'success' && needs.post-slack-message.result == 'success' && needs.request-reviewers.outputs.reviewers != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: "2454947"
          private-key: ${{ secrets.OOI_PULL_REQUEST_APP }}
      - name: Post PR comment
        run: |
          set -euo pipefail

          MESSAGE_TS="${{ needs.post-slack-message.outputs.message-ts }}"
          COMMENT_BODY="Pickaroo selected and notified reviewers for this PR! ðŸ¦˜

          message_ts: $MESSAGE_TS"

          echo "Posting comment to PR #${{ github.event.pull_request.number }}"
          if ! gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -X POST \
            -f body="$COMMENT_BODY" 2>&1; then
            echo "ERROR: Failed to post PR comment"
            exit 1
          fi

          echo "Successfully posted PR comment"
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}

  remove-label:
    # only remove a label if one was added
    if: ${{ always() && github.event.action == 'labeled' }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: "2454947"
          private-key: ${{ secrets.OOI_PULL_REQUEST_APP }}
      - name: Remove triggering label
        run: |
          set -euo pipefail

          echo "Removing label '${{ github.event.label.name }}' from PR #${{ github.event.pull_request.number }}"
          if ! gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels/${{ github.event.label.name }} \
            -X DELETE 2>&1; then
            echo "WARNING: Failed to remove label '${{ github.event.label.name }}'"
          else
            echo "Successfully removed label"
          fi
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}

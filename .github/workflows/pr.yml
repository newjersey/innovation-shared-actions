name: "Pull Request Review"

on:
  pull_request:
    # types: [labeled]
  push:
    branches:
      - main

jobs:
  request-reviewers:
    # if: ${{ github.event.label.name == 'request-code-review' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      slack-mentions: ${{ steps.map-slack-ids.outputs.slack-mentions }}
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: "2454947"
          private-key: ${{ secrets.OOI_PULL_REQUEST_APP }}
      - uses: actions/checkout@v5
      - name: Request Reviewers
        id: request-reviewers
        uses: ./.github/actions/pickaroo
        with:
          include-teams: "innovation-platform-eng"
          exclude-teams: "business-dev resx-ccm-project"
          number-of-reviewers: 8
          token: ${{ steps.generate_token.outputs.token }}
      - name: "Map slack ids to usernames"
        id: map-slack-ids
        shell: bash
        run: |
          REVIEWERS_STRING='${{ steps.request-reviewers.outputs.selected-reviewers }}'

          if [ -n "$REVIEWERS_STRING" ]; then
            REVIEWERS_JSON=$(echo "$REVIEWERS_STRING" | tr ' ' '\n' | jq -R -s 'split("\n") | map(select(length > 0))')
            GH_SLACK_MAPPING='${{ vars.GH_SLACK_IDS }}'
            SLACK_MENTIONS=$(echo "$REVIEWERS_JSON" | jq -r --argjson mapping "$GH_SLACK_MAPPING" '
              map(. as $user | 
                if $mapping[$user] then 
                  "<@" + $mapping[$user] + ">" 
                else 
                  "@" + $user 
                end
              ) | 
              join(", ")
            ')
          else
            SLACK_MENTIONS=""
          fi

          echo "slack-mentions=$SLACK_MENTIONS" >> $GITHUB_OUTPUT

  post-slack-message:
    needs: request-reviewers
    uses: ./.github/workflows/slack.yml
    permissions:
      contents: read
    with:
      channel_id: C09Q36G9HMX
      message: "[ <${{ github.event.pull_request.html_url }}|PR Review> ] ${{ github.event.repository.name }} - #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
      thread_message: "Hey ${{ needs.request-reviewers.outputs.slack-mentions }} ğŸ«µ! Please review the above pull request ğŸ™ğŸ•µï¸"
    secrets: inherit
